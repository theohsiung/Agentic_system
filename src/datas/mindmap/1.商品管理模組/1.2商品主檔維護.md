# 1. 功能概述 (Overview)
商品主檔維護功能提供貨主管理商品基礎資料，包括商品基本屬性、分類、效期屬性、
包裝階層、條碼資訊、倉儲屬性與供應商引用等。並支援新增、修改、刪除、查詢功能，
同時維持資料唯一性、更新快取、並發布事件供外部系統同步。

# 2. 版本紀錄 (Revision History)
| 修訂內容                 | 版本 | 作者 | 日期        |
| ------------------------ | ---- | ---- | ----------- |
| 公版初版                 | V1.0 | tong | 2025.3.20   |
| 會議確認                 | V1.1 | tong | 2025.4.2    |
| 增加供應商引用邏輯       | V1.2 | tong | 2025.4.16   |

# 3. 使用的倉庫參數 (Warehouse Parameters)
1. 最大堆疊層數：預設 99  
2. 每層最大數量：預設 99  
3. 最大重量（依重量單位 g/kg 設定）：預設 999,999  

# 4. 功能範圍 (Scope)
- 查詢商品主檔  
- 新增商品  
- 修改商品  
- 刪除商品  
- 新增導入  
- 更新導入  

# 5. 詳細規格 (Specifications)

========================================================
## 5.1 查詢（後端）

### 5.1.1 支援的查詢欄位
1. 貨主編號  
2. 商品編號  
3. 商品類別編號  
4. 溫層  
5. 啟用狀態  
6. 商品條碼  
7. ABC 分類  
8. 供應商編號  
9. 異動日期  

### 5.1.2 全查排序
- 按商品編號（小 → 大）排序  

### 5.1.3 Popup 簡查
1. 商品編號（小 → 大）排序  
2. 僅返回：商品編號、商品名稱  
3. 僅返回啟用狀態 = Y 的商品  

### 5.1.4 Grid 排序
1. 總覽明細：貨主（小→大）＋ 商品編號（小→大）  
2. 包裝明細：入數（小→大）  
3. 條碼明細：條碼（小→大）  
4. 商品主檔修改記錄：修改日期（大→小）  
5. 商品包裝修改記錄：修改日期（大→小）  

========================================================
## 5.2 新增（後端）

### 5.2.1 校驗規則
1. 商品包裝明細至少需 1 筆  
2. 包裝階層不得超過三階（依參數 V1.1）  
3. 必須存在 1 筆入數=1 的包裝  
4. 包裝入數不可重複  
5. 包裝單位不可重複  
6. 包裝階層 < 3 時，不可設定中包裝  
7. 中包裝設定僅允許 1 筆  
8. 包裝體積階層需由小至大排列  
9. 包裝重量不得超過系統最大重量參數  
10. 包裝重量階層需由小至大排列  
11. 包裝條碼需存在於商品條碼明細  
12. 商品條碼需至少 1 筆預設＝Y  
13. 商品條碼預設＝Y 僅允許 1 筆  
14. 效期控管商品：保存天數 > 0  
15. 效期控管：允收天數 ≤ 保存天數  
16. 效期控管：允出天數 ≤ 保存天數  
17. 效期控管：允退天數 ≤ 保存天數  
17.1 效期控管：允出天數 ≤ 允收天數（V1.1）  
18. 棧板單位需存在於包裝單位內  
19. 堆疊層數不得超過參數  
20. 每層數量不得超過參數  
21. 出貨批量需 ≥ 1  
22. 異型品與進立庫不得同時設定  
23. 異型品與進料箱不得同時設定  
24. 異型品與 AGV 貨架不得同時設定  
25. 若設定 進料箱/AGV 貨架 → 需設定箱最大量/最小量  
26. 商品編號不可重複  
27. 商品條碼不可於其他商品中重複出現  

### 5.2.2 後端邏輯
1. 生成商品物件（商品編號、名稱、貨主、建立人）  
2. 記錄其他資料（商品類別、溫層、包裝等）  
3. 最大包裝設定箱標記=1，其餘=0  
4. 栈板堆疊資料換算滿板量  
5. 若非效期控管 → 允收/允出/允退天數=0  
6. 寫入資料庫  
7. 發布事件：`EventName.CreateProduct` (Hand)  
8.（移除）不再遞增貨主使用次數  
9. 供應商使用次數 +1（V1.2）  

========================================================
## 5.3 修改（後端）

### 5.3.1 校驗規則
1. 同新增校驗（排除「商品編號重複」校驗）  
2. 商品有庫存 → 不可修改批號控管  
3. 商品有庫存 → 不可修改效期控管  
4. 商品有庫存 → 不可修改重量控管  
6. 商品有庫存 → 不可修改序列號控管（V1.1）  

### 5.3.2 後端邏輯
1. 依 S_ID 取得商品物件  
2. 更新名稱、備註、規格、修改人員與時間  
3. 最大包裝設定箱標記=1，其餘=0  
4. 重新換算滿板量  
5. 若非效期控管 → 允收/允出/允退天數=null（V1.1）  
6. 紀錄變更日誌（商品主檔欄位、包裝明細）  
7. 保存至資料庫  
8. 發布事件：`EventName.UpdateProduct` (Hand)  
9. 若存在 Redis 快取 → 刪除快取  
10. 依供應商變動計算遞增/遞減（V1.2）  

========================================================
## 5.4 刪除（後端）

### 5.4.1 校驗規則
0. 資料是否存在  
1. 是否存在庫存  
2. 是否在儲位商品指派中  
3. 是否被單據引用（入出庫、調撥等）  

### 5.4.2 後端邏輯
1. 依 S_ID 取得商品物件  
2. 自資料庫刪除  
3. 發布事件：`EventName.DeleteProduct` (Hand)  
4. 若有 Redis 快取 → 刪除  
5.（移除）不再遞減貨主使用次數  
6. 供應商使用次數 −1（V1.2）  

========================================================
## 5.5 新增導入（後端）

### 5.5.1 校驗規則
1. Excel 格式校驗  
1.1 必填欄位  
1.2 數字格式  
1.3 N/Y 格式  
1.4 溫層格式  
2. 貨主編號校驗  
3. 供應商編號校驗  
4. 同貨主+商品編號分組 → 主表資料需一致  
5. 商品類別校驗  
6. 條碼重複（MongoDB）  
7. 僅允許新增，不允許修改（V1.1）  
8. 建立導入類  
9. 包裝校驗  
10. 效期控管校驗  
11. 錯誤訊息整理  
12. 依參數判定是否可部分保存（預設：全部儲存）  

### 5.5.2 後端邏輯
1. 套用新增邏輯  
2. 批量寫入資料庫  
3. 發布導入事件：`EventName.CreateProduct,Import`  
4. 供應商使用次數 +1（V1.2）  

========================================================
## 5.6 更新導入（後端）

### 5.6.1 校驗（商品基本資料更新）
1. ABC 分類不可為空；僅允許：A / B / C  
2. 若進料箱=Y → 預設裝箱量不可為空  
3. 若進料箱=Y → 裝箱方式不可為空  
4. 裝箱方式允許：整箱(1)、1/2、1/4（V1.1）  

### 5.6.2 校驗（包裝體積／重量更新）
1. 重量階層需由小至大  
2. 體積階層需由小至大  
3. 堆疊層數不可超過參數  
4. 每層數量不可超過參數  

### 5.6.3 後端邏輯
1. 依貨主+商品編號取得商品  
2. 更新 Excel 相應資料  
3. 批次寫入資料庫  
4. 發布事件：`EventName.UpdateProduct,Import`  

========================================================

# 6. 系統事件 (Domain Events)
- EventName.CreateProduct  
- EventName.UpdateProduct  
- EventName.DeleteProduct  
- EventName.CreateProduct,Import  
- EventName.UpdateProduct,Import  

# 7. Redis 快取行為
- 新增：寫入  
- 修改：刪除（由統一入口重新建立）  
- 刪除：刪除  

# 8. 使用次數邏輯
- 供應商：新增 +1、刪除 −1、修改依變動調整  
- 貨主：不再依商品主檔計算（由商品類別承擔）  